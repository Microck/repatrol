---
phase: 03-chaos-agent
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/models/bug.py
  - src/models/__init__.py
  - src/evidence/capture.py
  - src/evidence/__init__.py
  - scripts/bug_model_smoke.py
autonomous: true

must_haves:
  truths:
    - "When a failure is detected, the system can serialize a BugReport with state + evidence paths"
    - "BugReports can be saved to disk and reloaded later for reporting"
  artifacts:
    - path: "src/models/bug.py"
      provides: "BugReport model with repro steps + evidence pointers"
      contains: "class BugReport"
    - path: "src/evidence/capture.py"
      provides: "Capture helpers: screenshot + state snapshot + metadata"
      contains: "def capture_bug_evidence"
  key_links:
    - from: "src/evidence/capture.py"
      to: "src/automation/recorder.py"
      via: "capture_screenshot"
      pattern: "capture_screenshot"
---

<objective>
Define the bug data contract and implement evidence capture helpers (screenshot + state snapshot) that Chaos can call when it detects a crash/hang.

Purpose: Reporting requires structured bug artifacts, not ad-hoc logs.
Output: Bug model + evidence capture helpers + smoke tool.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@src/vision/game_state.py
@src/core/run_context.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BugReport model + JSON persistence helpers</name>
  <files>
src/models/__init__.py
src/models/bug.py
  </files>
  <action>
Create a single canonical bug report format.

- Include:
  - `bug_id`, `run_id`, timestamps
  - `detector` (crash/hang) and `reason`
  - `last_state` (`GameState` as dict)
  - `repro_steps` (list of human-readable steps)
  - `evidence` (paths for screenshot + video; `video_path` may be null if recording disabled)
- Provide `to_json(path)` and `from_json(path)` convenience helpers.
  </action>
  <verify>
python3 -m compileall src
python3 -c "from src.models.bug import BugReport; print(BugReport.__name__)"
  </verify>
  <done>
Bug reports can be serialized to disk and reloaded deterministically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add evidence capture helper + smoke runner</name>
  <files>
src/evidence/__init__.py
src/evidence/capture.py
scripts/bug_model_smoke.py
  </files>
  <action>
Create a helper that turns "something went wrong" into a concrete artifact bundle.

- Implement `capture_bug_evidence(ctx: RunContext, page, state, label)` that:
  - writes a screenshot via `SessionRecorder` (if attached)
  - writes a `bug_state.json` snapshot
  - returns evidence paths including `video_path` if known in the current run context.
- Add `scripts/bug_model_smoke.py` that creates a fake BugReport with evidence paths and round-trips it to disk.
  </action>
  <verify>
python3 scripts/bug_model_smoke.py --out artifacts/bug_smoke.json
  </verify>
  <done>
Smoke runner writes a bug JSON and reloads it without schema loss.
  </done>
</task>

</tasks>

<verification>
- BugReport schema has enough fields to generate a GitHub issue later (title, repro, expected/actual placeholders).
</verification>

<success_criteria>
- CHAOS-04 unblocked: bug state capture format exists (screenshot + state snapshot).
</success_criteria>

<output>
After completion, create `.planning/phases/03-chaos-agent/03-02-SUMMARY.md`
</output>
