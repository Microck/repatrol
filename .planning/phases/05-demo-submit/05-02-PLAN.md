---
phase: 05-demo-submit
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - scripts/run_demo.py
  - scripts/record_demo_video.py
  - demo/video.mp4
autonomous: true

user_setup:
  - service: ffmpeg
    why: "Convert Playwright .webm recording to demo/video.mp4"
    precheck:
      - command: "ffmpeg -version"
        expected: "prints version and exits 0"
    install_hints:
      - "Ubuntu/Debian: sudo apt-get update && sudo apt-get install -y ffmpeg"
      - "macOS: brew install ffmpeg"
      - "Windows: install ffmpeg and ensure it's on PATH"

must_haves:
  truths:
    - "There is a deterministic, locally runnable target web game for the demo"
    - "Running the demo script reliably yields at least one bug artifact"
    - "A 2-minute demo video artifact is generated as demo/video.mp4"
  artifacts:
    - path: "demo/buggy_web_game/index.html"
      provides: "Local target game (intentionally buggy)"
      contains: "Buggy Web Game"
    - path: "scripts/run_demo.py"
      provides: "One-command demo runner"
      contains: "--serve"
    - path: "demo/video.mp4"
      provides: "2-minute demo recording"
      contains: ""
  key_links:
    - from: "scripts/run_demo.py"
      to: "scripts/run_swarm.py"
      via: "invokes orchestrator"
      pattern: "run_swarm"
---

<objective>
Create a deterministic demo run that proves the game is runnable, the bug is triggerable, and a 2-minute video artifact can be generated.

Purpose: DEMO-02/DEMO-03 should not depend on randomness or external games.
Output: Demo runner + demo video artifact.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@scripts/run_swarm.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add run_demo.py to serve the in-repo buggy game and run the orchestrator in demo mode</name>
  <files>
 scripts/run_demo.py
  </files>
  <action>
Create a single script to produce the full demo artifacts.

- `scripts/run_demo.py` should:
  - start a local static file server for `demo/buggy_web_game/` on a known port
  - set `TARGET_GAME_URL` env var to that server URL
  - invoke the swarm runner in `--mode demo` with recording enabled
  - print the resulting bug report path + (optional) issue URL.
- Prefer using Python stdlib `http.server` for serving.
  </action>
  <verify>
 python3 scripts/run_demo.py --help
  </verify>
  <done>
One command exists that sets up the local game and runs the full swarm demo flow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add record_demo_video.py to generate demo/video.mp4 and assert the bug triggers</name>
  <files>
scripts/record_demo_video.py
  </files>
  <action>
Create `scripts/record_demo_video.py` that produces the required submission video artifact.

- Start the local server for `demo/buggy_web_game/` (reuse the same port convention as `run_demo.py`).
- Use Playwright video recording (context `record_video_dir`) to capture a deterministic reproduction run:
  - open the page
  - execute the documented click sequence to trigger the uncaught exception
  - assert the failure is observed (via CrashDetector wiring or Playwright `pageerror` event)
- Close the context to finalize the `.webm` recording.
- Convert the resulting `.webm` to `demo/video.mp4` using `ffmpeg` (`ffmpeg -y -i input.webm -c:v libx264 -c:a aac demo/video.mp4`).
  - fail with a clear error if `ffmpeg` is not available (include install hints for common OSes).
- Ensure the script exits non-zero if the bug does not trigger or if the mp4 is missing/empty.
  </action>
  <verify>
 ffmpeg -version
 python3 scripts/record_demo_video.py --help
 python3 scripts/record_demo_video.py --out demo/video.mp4
  </verify>
  <done>
Running the script produces `demo/video.mp4` and fails loudly if the bug is not triggerable.
  </done>
</task>

</tasks>

<verification>
- `python3 scripts/run_demo.py --serve --mode demo` produces `artifacts/...` with a bug JSON.
- `python3 scripts/record_demo_video.py` produces `demo/video.mp4` and asserts the bug triggers via Playwright pageerror/crash signal.
</verification>

<success_criteria>
- DEMO-02 unblocked: game is runnable locally and the bug is deterministically triggerable.
- DEMO-03 unblocked: `demo/video.mp4` is produced via scripted run.
</success_criteria>

<output>
After completion, create `.planning/phases/05-demo-submit/05-02-SUMMARY.md`
</output>
