---
phase: 04-reporting
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - src/integrations/github.py
  - src/integrations/__init__.py
  - src/storage/evidence.py
  - scripts/evidence_smoke.py
  - scripts/github_issue_smoke.py
autonomous: true
user_setup:
  - service: github
    why: "Create issues + (optional) upload evidence as release assets"
    env_vars:
      - name: GITHUB_TOKEN
        source: "GitHub Settings -> Developer settings -> Personal access tokens"
      - name: GITHUB_REPO
        source: "owner/repo string (e.g. myorg/stream-qa-swarm)"

must_haves:
  truths:
    - "A BugReport can be turned into a GitHub issue body with repro steps"
    - "Issue creation supports dry-run so development does not require credentials"
    - "Evidence can optionally be published as a shareable URL via GitHub release assets"
  artifacts:
    - path: "src/integrations/github.py"
      provides: "GitHub REST helpers (issues + releases) with dry-run support"
      contains: "class GitHubIssueClient"
    - path: "src/storage/evidence.py"
      provides: "GitHubReleaseEvidenceStore for publishing evidence assets"
      contains: "class GitHubReleaseEvidenceStore"
    - path: "scripts/github_issue_smoke.py"
      provides: "Smoke: read BugReport -> render -> (dry-run) create issue"
      contains: "--dry-run"
  key_links:
    - from: "src/integrations/github.py"
      to: "src/models/bug.py"
      via: "BugReport -> issue payload"
      pattern: "BugReport"
---

<objective>
Implement GitHub issue creation and a deterministic issue template for bug reports, including evidence links.

Purpose: Deliver REP-03 with the minimum external surface area.
Output: GitHub integration client + smoke runner.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@src/models/bug.py
@src/storage/evidence.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement GitHub REST client (issues + releases) with dry-run support (stdlib only)</name>
  <files>
 src/integrations/__init__.py
 src/integrations/github.py
  </files>
  <action>
Implement a small REST client (stdlib `urllib.request`) for GitHub issues + release assets.

- Support:
  - `create_issue(title, body, labels)`
  - `comment(issue_number, body)` (optional, for follow-ups)
  - `get_or_create_release(tag, name)`
  - `upload_release_asset(release_id, name, content_type, bytes)`
- Require `GITHUB_TOKEN` only when not in dry-run.
- Keep payload template stable:
  - Summary
  - Steps to reproduce
  - Expected vs actual
  - Evidence links (from `EvidenceRef.url` when available, else local paths)
  - Environment (OS, browser, run id)
  </action>
  <verify>
python3 -m compileall src
python3 -c "from src.integrations.github import GitHubIssueClient; print(GitHubIssueClient)"
  </verify>
  <done>
GitHub client can render a request payload and skips network calls in dry-run mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement GitHubReleaseEvidenceStore and extend evidence smoke (dry-run supported)</name>
  <files>
 src/storage/evidence.py
 scripts/evidence_smoke.py
  </files>
  <action>
Add optional evidence publishing via GitHub release assets.

- Implement `GitHubReleaseEvidenceStore` that:
  - creates (or reuses) a release/tag for a run id (e.g. `evidence-<run_id>`)
  - uploads evidence files as release assets
  - returns `EvidenceRef` with `url` populated from `browser_download_url` (or constructed asset URL).
- Use the GitHub REST client from `src/integrations/github.py` (no duplicated HTTP logic).
- Extend `scripts/evidence_smoke.py` to support:
  - `--mode local`
  - `--mode github-release --dry-run` (prints placeholder URLs without network)
  </action>
  <verify>
 python3 scripts/evidence_smoke.py --mode local
 python3 scripts/evidence_smoke.py --mode github-release --dry-run
  </verify>
  <done>
 Evidence publishing flow works in dry-run and returns URL-shaped refs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add issue smoke runner (render + optional create) that includes video evidence links</name>
  <files>
scripts/github_issue_smoke.py
  </files>
  <action>
Create a smoke script that validates end-to-end issue rendering.

- Input: `--bug artifacts/bugs/<id>.json`
- Output:
  - always prints the rendered markdown to stdout
  - in `--dry-run`, does not create an issue; prints the rendered markdown to stdout
  - without `--dry-run`, creates issue and prints issue URL.
 - Ensure the rendered body includes video evidence when present:
   - if `EvidenceRef.url` exists, link it
   - else include the local `path`.
  - When `BugReport.evidence.video_path` is set, assert the file exists and ensure the rendered issue body includes a link (or path) to it.
   </action>
   <verify>
  python3 scripts/github_issue_smoke.py --help
  python3 scripts/bug_model_smoke.py --out artifacts/tmp_bug.json
  python3 -c "import json, pathlib; bugp=pathlib.Path('artifacts/tmp_bug.json'); bug=json.loads(bugp.read_text()); vid=pathlib.Path('artifacts/evidence/demo_video.mp4'); vid.parent.mkdir(parents=True, exist_ok=True); vid.write_bytes(b'0'); bug.setdefault('evidence', {})['video_path']=str(vid); bugp.write_text(json.dumps(bug, indent=2, sort_keys=True)); print(vid)"
  python3 scripts/github_issue_smoke.py --dry-run --bug artifacts/tmp_bug.json > artifacts/tmp_issue_body.md
  python3 -c "import pathlib; vid=pathlib.Path('artifacts/evidence/demo_video.mp4'); assert vid.exists(); body=pathlib.Path('artifacts/tmp_issue_body.md').read_text(); assert str(vid) in body or vid.name in body"
   </verify>
   <done>
 Issue smoke runner renders a complete issue body from a BugReport (even offline); when a `video_path` is present and exists on disk, it is referenced in the rendered issue body.
   </done>
 </task>

</tasks>

<verification>
- With a configured token/repo, a real issue can be created and includes evidence links.
</verification>

<success_criteria>
- REP-03 unblocked: GitHub issue creation exists (dry-run + real mode).
</success_criteria>

<output>
After completion, create `.planning/phases/04-reporting/04-02-SUMMARY.md`
</output>
