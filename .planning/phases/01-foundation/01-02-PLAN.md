---
phase: 01-foundation
plan: 02
type: execute
wave: 3
depends_on:
  - "01-01"
files_modified:
  - src/automation/recorder.py
  - src/automation/__init__.py
  - scripts/run_recording_smoke.py
autonomous: true

user_setup:
  - service: ffmpeg
    why: "Optional conversion of Playwright-recorded videos to demo-friendly mp4"
    precheck: "ffmpeg -version"
    install_hint: "Install `ffmpeg` via your OS package manager"

must_haves:
  truths:
    - "A full gameplay session can be recorded to a video file"
    - "Screenshots and videos are written to a predictable artifacts directory"
  artifacts:
    - path: "src/automation/recorder.py"
      provides: "Session recording utilities (video + screenshots)"
      contains: "class SessionRecorder"
    - path: "scripts/run_recording_smoke.py"
      provides: "Recording smoke test runner"
      contains: "--record"
  key_links:
    - from: "src/automation/recorder.py"
      to: "playwright"
      via: "browser context video recording"
      pattern: "record_video_dir"
---

<objective>
Add deterministic session recording (video + screenshots) so later bug reports can include evidence.

Purpose: Evidence capture is core to the product and demo.
Output: Recorder abstraction + smoke runner that produces a video artifact.
</objective>

<execution_context>
@/home/ubuntu/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@../../plans/stream-qa-swarm.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SessionRecorder using Playwright video capture</name>
  <files>
src/automation/recorder.py
src/automation/__init__.py
  </files>
  <action>
Implement a small recorder wrapper that can be used by agents and the orchestrator.

- Use Playwright context video recording (`record_video_dir`) for browser-based capture.
- In `SessionRecorder`, standardize artifact paths under `artifacts/`:
  - `artifacts/videos/{run_id}/` for video outputs
  - `artifacts/screenshots/{run_id}/` for screenshots
- Provide methods:
  - `new_run_id()` (timestamp + random suffix)
  - `attach_to_context(context)` (configures context for video output)
  - `capture_screenshot(page, label)`
  - `finalize(context)` (closes context, returns final video path)
- Keep it pure filesystem; no Azure/remote storage in Phase 1.
  </action>
  <verify>
python3 -m compileall src
python3 -c "from src.automation.recorder import SessionRecorder; print(SessionRecorder.new_run_id())"
  </verify>
  <done>
Recorder imports cleanly and provides stable artifact directory conventions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add recording smoke script that produces a playable video</name>
  <files>
scripts/run_recording_smoke.py
  </files>
  <action>
Create `scripts/run_recording_smoke.py` that:

 - Starts/stops the local demo game server automatically when `--url` is not provided (same behavior as `scripts/run_smoke.py`).
 - Launches the game page (reuse the same URL env var convention from `src/config/target_game.py`).
 - Records for ~5-10 seconds while performing a couple clicks.
 - Finalizes and prints the resulting video path.
 - If `ffmpeg` is available (`ffmpeg` on PATH), also write an `.mp4` copy alongside the recorded file for easier demo playback.
 - Exits non-zero if the final video file is missing or empty (and if ffmpeg conversion was attempted, the mp4 is also missing/empty).
  </action>
  <verify>
 python3 scripts/serve_buggy_web_game.py --check
 python3 scripts/run_recording_smoke.py --headless
  </verify>
  <done>
 Smoke run writes `artifacts/videos/<run_id>/*` and prints a path to the final video file (and an `.mp4` copy when ffmpeg is available).
  </done>
</task>

</tasks>

<verification>
- Recording smoke run produces a non-empty video file.
</verification>

<success_criteria>
- FOUND-04 unblocked: a scripted session yields a video artifact reliably.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
